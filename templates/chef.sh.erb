#!/bin/bash
set -e

# Clone or update the chaos chef repository
if [ -d /var/lib/chaos/chaos-chef-repo/.git ]; then
  cd /var/lib/chaos/chaos-chef-repo
  git pull origin master &> /dev/null
else
  mkdir -p /var/lib/chaos
  cd /var/lib/chaos
  git clone -b <%= CHAOS_CHEF_REPO_BRANCH || "master" %> <%= CHAOS_CHEF_REPO %> &> /dev/null
fi

# Run chef
chef-solo --config /var/lib/chaos/chaos-chef-repo/solo.rb --json-attributes /var/lib/chaos/chaos-chef-repo/node.json --force-formatter --log_level error